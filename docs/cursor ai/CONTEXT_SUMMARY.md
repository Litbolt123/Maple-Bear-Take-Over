## Maple Bear Takeover – Context Summaries

This file is where I will write human-readable summaries of my current understanding of the project and recent changes, so you can verify I'm not missing key information.

---

### Snapshot – Current Understanding (created by AI)
- **Addon Focus**: Apocalypse-style Minecraft Bedrock addon where evolving Maple Bears spread a mysterious white powdery infection across any world, with progressive day milestones (2,4,8,13,20,25 and a planned 100-day arc that has both an achievement and a lore payoff).
- **Core Systems**: Unified infection system (snow + bear hits), tiered snow mechanics (6 tiers, from mild relief to Black Void), player transformation into named infected bears on death, cure/immunity loop (weakness + enchanted golden apple, temporary immunity broken by snow), Codex/journal UI, and a day tracker driving escalation and late-game lore.
- **Bear Ecosystem**: Tiny, Infected, Buff, Flying, Mining, Torpedo, and infected livestock, with day-based variants; **spawn progression**: Flying Bears start on day 8 (swapped from day 11), Buff Bears start on day 13 (swapped from day 8) - this swap was done for gameplay balance; buff bears are mini-bosses with limited spawn counts and snow-heavy loot; flying bear health has been tuned to sit between tiny and infected bears; mining/torpedo/flying AI have custom scripts and optional debug logging via the Codex. **Day Color System**: Colors now accurately reflect actual lethality - Day 8 shows light red (§c) with 4 exclamations (was amber with 3) because flying bears, day8 variants, and infected_day8 all spawn; Day 13 shows light red (§c) with 5 exclamations because buff bears arrive. The progression ranges in the codex have been updated to match: Days 8-10 = "High Danger", Days 13-15 = "Critical".
- **Mining AI Behavior**: Mining bears prioritize walking/climbing toward targets first, only mining when physically blocked. They use an adaptive mining strategy, evaluating multiple options (pitfall, regular stairs, spiral stairs) and choosing the most effective one based on terrain and target position. When within 7 blocks horizontally AND has line of sight, bears stop mining and let native AI handle attacking. Bears can walk through non-solid blocks (grass, flowers, water) and jump over single-block obstacles instead of mining them. Bears ignore players in creative and spectator modes (checked at multiple points: `findNearestTarget`, `getStoredTargetInfo`, `processContext` start, and before creating context). Bears can target villagers in addition to players and other mobs. **Target Coordination and Attack Behavior**: Bears can see and attack targets even if the targeting system is full (MAX_BEARS_PER_TARGET = 2). Bears that can see a target but aren't actively registered can still attack like normal hostile mobs (native AI handles it), but they won't mine. If a bear has clear line of sight (0 blocks obstruction) to a target and is within 12 blocks horizontally and 8 blocks vertically, they can join the targeting system (if there's room), allowing them to mine. Only bears that are actively registered in the targeting system can mine - this prevents too many bears from mining at once while still allowing all bears to attack visible targets. **Vertical Mining Strategy**: When the target is below, bears use an adaptive descending strategy: for deep descents (4+ blocks), they prefer spiral stairs (`carveSpiralStair` going down) over regular ramps, as spirals are more efficient for deep vertical movement. For moderate descents (2-4 blocks), they use regular ramps (`carveRampDown`). Straight-down mining (`clearVerticalColumn`) is only used when the target is very close (within 1 block below), otherwise ramps/spirals are created to allow natural descent. This prevents bears from mining straight down when they should create walkable paths. Spiral stairs work for both ascending and descending, making them versatile for tall structures. **Target Coordination**: Only 2 bears can target the same target at once (MAX_BEARS_PER_TARGET = 2). The closest bear becomes the leader (mines blocks), while the other becomes a follower (follows without mining). Extra bears will find different targets or wait. Bears detect other entities (especially other bears) in their pathfinding and don't treat them as permanent obstacles - they can navigate around each other. Bears proactively create stairs/ramps while moving toward targets above/below, not just when directly below/above. Direction changes are more responsive when stuck (20 ticks detection, 10 ticks for direction changes). **Block Prioritization**: When moving toward targets at different Y levels, bears prioritize breaking blocks directly in front of them (at their current Y level) FIRST, before checking blocks at the target's Y level. This ensures immediate progress and prevents bears from trying to break unreachable blocks. **Reach Checks**: All block breaking functions (`breakWallAhead`, `carveStair`, `carveRampDown`, loop detection) now check if blocks are within reach (6 blocks) before attempting to break them. This prevents bears from getting stuck trying to break blocks that are too far away (e.g., 10+ blocks). Bears will skip unreachable blocks and focus on building stairs/ramps closer first, then break target-level blocks once they're within reach. Comprehensive test scenarios are documented in `../development/TEST_SCENARIOS.md`.
- **Dimensions & Biomes**: Infection now spans all three dimensions (Overworld, Nether, End) with variable-sized infected biome generation. **Overworld**: Custom `mb:infected_biome` replaces a wide range of vanilla biomes with three size variants (large/medium/small patches) using different `noise_frequency_scale` values (0.1 for huge biomes, 5 for normal, 80 for tiny scattered patches). **Nether**: Infected biome replaces all 5 vanilla Nether biomes (nether_wastes, crimson_forest, warped_forest, soul_sand_valley, basalt_deltas) with variable sizes at ~0.08 density per biome. **End**: Infected biome replaces all 5 vanilla End biomes (the_end, end_highlands, end_midlands, end_barrens, small_end_islands) with variable sizes at ~0.06 density per biome (lowest density - End should feel more isolated). Spawn system supports dimension-specific blocks: `dusted_dirt`/`snow_layer` in Overworld, `netherrack` in Nether, `end_stone` in End. Some overworld biomes remain relatively safer because the infected biome doesn't target them - **Mushroom Fields** appears to be the safest (see `../design/SAFE_BIOMES.md` for complete list).
- **Atmosphere & Tone**: Drug/addiction metaphor for the powder (kept ambiguous), slow-burn horror that gets darker as players go deeper (higher snow tiers, later days), themes of memory/counting/world observing players; journal is gameplay-only, not lore.
- **Player Transformation Details**: When infected players die—either by infection timer or killed by any Maple Bear—they do **not** control a new form; instead an infected Maple Bear spawns at their death location with a red nametag like `! <player>'s Infected Form`, currently using normal infected bear stats/variants chosen by day, and multiple deaths can leave multiple such bears in the world.
- **Co-op & Infection Spread**: Designed for both solo and multiplayer but co-op is a core use case; codex/knowledge can already be shared between nearby players, and long-term design includes always-on player-to-player infection at high infection stages (with a dev-tools toggle).
- **Enemy Roles Over Time**: Early game is planned to be plague-agent heavy (roughly 60% spreaders / 40% killers) so new areas get corrupted, while late game flips toward 60% killers / 40% spreaders to keep established bases under constant threat; wave days and milestone spikes (e.g., 50/75/100) will sit on top of the existing linear ramp.
- **Dimension Adaptations**: **Nether Fire Resistance System**: Bears in the Nether gain fire resistance based on their day variant, not time spent. **Day 4 and earlier variants** (`mb:mb`, `mb:mb_day4`, `mb:infected`): No fire resistance. **Day 8-17 variants** (`mb:mb_day8`, `mb:mb_day13`, `mb:infected_day8`, `mb:infected_day13`, `mb:buff_mb`, `mb:buff_mb_day13`, `mb:flying_mb`, `mb:flying_mb_day15`, `mb:mining_mb`, `mb:torpedo_mb`): Fire Resistance I with time-based limitations - must spend 200 ticks (10 seconds) in Nether before gaining fire resistance, then receive temporary 20-second fire resistance that expires and needs refresh (time is a factor since any fire resistance blocks all fire damage). **Day 20+ variants** (`mb:mb_day20`, `mb:infected_day20`, `mb:buff_mb_day20`, `mb:flying_mb_day20`, `mb:mining_mb_day20`, `mb:torpedo_mb_day20`): Fire Resistance III (complete immunity) immediately upon entering Nether. Fire resistance is removed when bears leave the Nether. **End Spawn Adjustments**: Flying and torpedo bear spawn rates are increased in the End dimension, scaling with world day progression (1.5x at day 20+, 2.0x at day 30+, 2.5x at day 40+, capped at 3.0x). Other bear types get reduced spawn rates (0.5x) in the End to make room for aerial threats. System implemented in `mb_dimensionAdaptation.js` and spawn controller.
- **Known Gaps / Future Work**: Buff/smarter player-infected forms, better rewards and unstuck behaviors for buff bears, Raptor Flying Bear implementation, more explicit 100-day "ending" structure with post-credits world state, player-to-player infection (always on, toggle in dev tools), curing & "scarred but special" animals (both mechanical buffs and cosmetic), building bear variants (bridges/structures - combo of functional but natural-ish, testing needed), and expanded docs (onboarding, troubleshooting, API usage) plus ongoing lore-accurate feature implementation from `../development/IDEA_BRAINSTORM.md`.
- **Spawn Controller Debug System**: The spawn controller has a comprehensive debug system accessible via the Codex journal (if player has `mb_cheats` tag). Debug menu button moved from "Developer Tools" to main journal menu for easier access. **New Debug Categories**: Added four new debug flags for spawn controller: `cache` (shows cache statistics and registration), `validation` (shows block validation checks), `distance` (shows distance filtering), and `spacing` (shows spacing filter results). **Toggle All Fix**: Fixed "Toggle All" button to properly toggle all flags including new ones by using `getDefaultDebugSettings()` helper function to get complete list of flags. Settings are now merged with defaults on load to ensure new flags are initialized even with old saved settings. **Debug Logging Improvements**: Enhanced debug logging to show TARGET_BLOCK constant value (`mb:dusted_dirt`) and detailed block type comparisons during scanning. Debug messages now show: block typeId, TARGET_BLOCK constant, match status, and distance for first 10 non-air blocks found. This helps diagnose why scans find 0 `mb:dusted_dirt` blocks (currently investigating - scan works correctly but finds no matching blocks in scanned area).


